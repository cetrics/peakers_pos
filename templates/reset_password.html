<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reset Password</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: Arial, sans-serif;
        background: #f9f9f9;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }
      .container {
        background: #fff;
        padding: 24px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        width: 350px;
        text-align: center;
        position: relative;
      }
      .logo img {
        height: 80px;
        width: 80px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 16px;
      }
      h2 {
        font-size: 24px;
        margin-bottom: 16px;
      }
      .input-group {
        margin-bottom: 16px;
        text-align: left;
        position: relative;
      }
      .input-group label {
        display: block;
        font-size: 14px;
        margin-bottom: 5px;
      }
      .input-group input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 16px;
      }
      .toggle-password {
        position: absolute;
        right: 10px;
        top: 35px;
        cursor: pointer;
        font-size: 16px;
        color: #666;
      }
      .password-requirements {
        font-size: 14px;
        text-align: left;
        margin-top: 8px;
      }
      .password-requirements span {
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .valid {
        color: #28a745;
      }
      .invalid {
        color: #dc3545;
      }
      .login-btn {
        background: black;
        color: white;
        border: none;
        padding: 10px;
        width: 100%;
        font-size: 16px;
        cursor: pointer;
        border-radius: 5px;
        transition: 0.3s;
        margin-top: 10px;
      }
      .login-btn:hover {
        background: #333;
      }
      .login-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .alert {
        display: none;
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 5px;
        font-size: 14px;
      }
      .alert.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .alert.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .redirect-loading {
        display: none;
        margin-top: 10px;
        font-size: 14px;
        color: #333;
        font-weight: bold;
      }
      .redirect-loading i {
        margin-right: 5px;
      }
      .loading {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="logo">
        <img src="../static/images/logos/main_logo.png" alt="Logo" />
      </div>
      <h2>Reset Password</h2>

      <div class="alert" id="alert"></div>

      <div class="redirect-loading" id="redirect-loading">
        <i class="fas fa-spinner fa-spin"></i> Redirecting to login...
      </div>

      <div class="input-group">
        <label for="new-password">New Password</label>
        <input
          type="password"
          id="new-password"
          required
          onkeyup="validatePassword()"
        />
        <i
          class="fas fa-eye toggle-password"
          onclick="togglePassword('new-password', this)"
        ></i>
        <div class="password-requirements">
          <span id="length" class="invalid"
            ><i class="fas fa-times"></i> At least 8 characters</span
          >
          <span id="uppercase" class="invalid"
            ><i class="fas fa-times"></i> At least 1 uppercase letter</span
          >
          <span id="lowercase" class="invalid"
            ><i class="fas fa-times"></i> At least 1 lowercase letter</span
          >
          <span id="number" class="invalid"
            ><i class="fas fa-times"></i> At least 1 number</span
          >
          <span id="special" class="invalid"
            ><i class="fas fa-times"></i> At least 1 special character</span
          >
        </div>
      </div>

      <div class="input-group">
        <label for="confirm-password">Confirm Password</label>
        <input
          type="password"
          id="confirm-password"
          required
          onkeyup="validatePassword()"
        />
        <i
          class="fas fa-eye toggle-password"
          onclick="togglePassword('confirm-password', this)"
        ></i>
      </div>

      <button
        type="button"
        class="login-btn"
        id="reset-btn"
        onclick="resetPassword()"
        disabled
      >
        <span id="btn-text">Reset Password</span>
        <i class="fas fa-spinner fa-spin loading" id="loading-icon"></i>
      </button>
    </div>

    <script>
      function validatePassword() {
        let password = document.getElementById("new-password").value;
        let confirmPassword = document.getElementById("confirm-password").value;
        let length = document.getElementById("length");
        let uppercase = document.getElementById("uppercase");
        let lowercase = document.getElementById("lowercase");
        let number = document.getElementById("number");
        let special = document.getElementById("special");
        let resetBtn = document.getElementById("reset-btn");

        // Password requirements validation
        let isLengthValid = password.length >= 8;
        let isUppercaseValid = /[A-Z]/.test(password);
        let isLowercaseValid = /[a-z]/.test(password);
        let isNumberValid = /[0-9]/.test(password);
        let isSpecialValid = /[@$!%*?&]/.test(password);
        let doPasswordsMatch = password === confirmPassword && password !== "";

        updateValidationStatus(length, isLengthValid);
        updateValidationStatus(uppercase, isUppercaseValid);
        updateValidationStatus(lowercase, isLowercaseValid);
        updateValidationStatus(number, isNumberValid);
        updateValidationStatus(special, isSpecialValid);

        // Visual feedback for password match
        const confirmField = document.getElementById("confirm-password");
        if (confirmPassword) {
          confirmField.style.borderColor = doPasswordsMatch
            ? "#28a745"
            : "#dc3545";
        } else {
          confirmField.style.borderColor = "#ccc";
        }

        resetBtn.disabled = !(
          isLengthValid &&
          isUppercaseValid &&
          isLowercaseValid &&
          isNumberValid &&
          isSpecialValid &&
          doPasswordsMatch
        );
      }

      function updateValidationStatus(element, isValid) {
        if (isValid) {
          element.classList.add("valid");
          element.classList.remove("invalid");
          element.innerHTML = `<i class="fas fa-check"></i> ${element.textContent
            .replace("❌", "")
            .trim()}`;
        } else {
          element.classList.remove("valid");
          element.classList.add("invalid");
          element.innerHTML = `<i class="fas fa-times"></i> ${element.textContent
            .replace("✔️", "")
            .trim()}`;
        }
      }

      function togglePassword(fieldId, icon) {
        let input = document.getElementById(fieldId);
        if (input.type === "password") {
          input.type = "text";
          icon.classList.replace("fa-eye", "fa-eye-slash");
        } else {
          input.type = "password";
          icon.classList.replace("fa-eye-slash", "fa-eye");
        }
      }

      function resetPassword() {
        const newPassword = document.getElementById("new-password").value;
        const confirmPassword =
          document.getElementById("confirm-password").value;
        const alertBox = document.getElementById("alert");
        const resetBtn = document.getElementById("reset-btn");
        const loadingIcon = document.getElementById("loading-icon");
        const btnText = document.getElementById("btn-text");

        // Validate passwords match
        if (newPassword !== confirmPassword) {
          alertBox.style.display = "block";
          alertBox.className = "alert error";
          alertBox.textContent = "Passwords don't match!";
          return;
        }

        // Disable button during request
        resetBtn.disabled = true;
        btnText.style.display = "none";
        loadingIcon.style.display = "inline-block";

        // Get token from URL
        const token = window.location.pathname.split("/").pop();

        fetch(window.location.href, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            password: newPassword,
          }),
        })
          .then((response) => {
            if (!response.ok) {
              return response.json().then((err) => {
                throw err;
              });
            }
            return response.json();
          })
          .then((data) => {
            alertBox.style.display = "block";
            alertBox.className = "alert success";
            alertBox.textContent = data.message || "Password reset successful!";

            setTimeout(() => {
              window.location.href = "/login";
            }, 2000);
          })
          .catch((error) => {
            alertBox.style.display = "block";
            alertBox.className = "alert error";
            alertBox.textContent = error.error || "Password reset failed";
            console.error("Error:", error);
          })
          .finally(() => {
            resetBtn.disabled = false;
            btnText.style.display = "inline-block";
            loadingIcon.style.display = "none";
          });
      }
    </script>
  </body>
</html>
